<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>ErlyComet</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Roberto Saccon">
	<!-- Date: 2007-11-22 -->
	
	<script type="text/javascript"
		djConfig="isDebug: true"
		src="http://o.aolcdn.com/dojo/1.0.0/dojo/dojo.xd.js"></script>
	
	<!-- for debugging cometd.js comment the script above and uncomment the script below -->
	<!-- (only makes sense if you put a local dojo and dojox in demo-docroot             -->  
	
    <!--
	<script type="text/javascript"
		djConfig="isDebug: true"
		src="dojo/dojo.js"></script>
	-->	
			
	<script type="text/javascript">	
        dojo.require("dojox.cometd");

		var counter = {
			start_stop: function(){
				if (dojo.byId("counter_button").innerHTML == "start"){
			      dojox.cometd.subscribe("/test/time", this, "update"); 
			      dojo.byId("counter_button").innerHTML = "stop";
			    } else {
			      dojox.cometd.unsubscribe("/test/time"); 
			      dojo.byId("counter_output").innerHTML = "";
			      dojo.byId("counter_button").innerHTML = "start";				   
			    }
			},
			update: function(msg){
				dojo.byId("counter_output").innerHTML = msg.data;
			}	
		}
		
		var rpc = {
			_id:0,
			invoke: function(){
				var text = dojo.byId('rpc_text').value;
				var delay = dojo.byId('rpc_delay').value;
				dojox.cometd.startBatch();
			    dojox.cometd.subscribe("/rpc/test", this, "result"); 	
			    dojox.cometd.publish("/rpc/test", { id:rpc._id, method:"delayed_echo", params:[text, delay]});				
			    dojox.cometd.endBatch();
			    rpc._id = rpc._id + 1;		   
			},
			result: function(msg){
				dojo.byId("rpc_output").innerHTML = msg.data.result;
				dojox.cometd.unsubscribe("/rpc/test"); 
			}	
		}		
		
		var room = {
		    _last: "",
		    _username: null,

		    join: function(name){

		        if(name == null || name.length==0 ){
		            alert('Please enter a username!');
		        }else{

		            this._username=name;
		            dojo.byId('join').className='hidden';
		            dojo.byId('joined').className='';
		            dojo.byId('phrase').focus();

		            // subscribe and join
			        dojox.cometd.startBatch();
		            dojox.cometd.subscribe("/chat/demo", room, "_chat");
		            dojox.cometd.publish("/chat/demo", { user: room._username, join: true, chat : room._username+" has joined"});
			        dojox.cometd.endBatch();

		            // handle cometd failures while in the room
		            room._meta=dojo.subscribe("/cometd/meta",function(event){
		                console.debug(event);   
		                if (event.action=="handshake") {
			                room._chat({data:{join:true,user:"SERVER",chat:"reconnected"}});
		                    dojox.cometd.subscribe("/chat/demo", room, "_chat");
		                } else if (event.action=="connect" && !event.successful) {
		                    room._chat({data:{leave:true,user:"SERVER",chat:"disconnected!"}});
			        }
		            });
		        }
		    },

		    leave: function(){
		        if (room._username==null) {
		            return;
				}

				if (room._meta) {
		    		dojo.unsubscribe(room._meta);
				}
				room._meta=null;

				dojox.cometd.startBatch();
		    	dojox.cometd.unsubscribe("/chat/demo", room, "_chat");
		    	dojox.cometd.publish("/chat/demo", { user: room._username, leave: true, chat : room._username+" has left"});
				dojox.cometd.endBatch();

		        // switch the input form
		        dojo.byId('join').className='';
		        dojo.byId('joined').className='hidden';
		        dojo.byId('username').focus();
		        room._username=null;
		    },

		    chat: function(text){
		        if(!text || !text.length){ return false; }
		        dojox.cometd.publish("/chat/demo", { user: room._username, chat: text});
		    },

		    _chat: function(message){
		        var chat=dojo.byId('chat');
		        if(!message.data){
		            alert("bad message format "+message);
		            return;
		        }
		        var from=message.data.user;
		        var special=message.data.join || message.data.leave;
		        var text=message.data.chat;
		        if(!text){ return; }

		        if( !special && from == room._last ){
		            from="...";
		        }else{
		            room._last=from;
		            from+=":";
		        }

		        if(special){
		            chat.innerHTML += "<span class=\"alert\"><span class=\"from\">"+from+"&nbsp;</span><span class=\"text\">"+text+"</span></span><br/>";
		            room._last="";
		        }else{
		            chat.innerHTML += "<span class=\"from\">"+from+"&nbsp;</span><span class=\"text\">"+text+"</span><br/>";
		        } 
		        chat.scrollTop = chat.scrollHeight - chat.clientHeight;    
		    },

		    _init: function(){
		        dojo.byId('join').className='';
		        dojo.byId('joined').className='hidden';
		        dojo.byId('username').focus();

		        var element=dojo.byId('username');
		        element.setAttribute("autocomplete","OFF"); 
		        dojo.connect(element, "onkeyup", function(e){   
		            if(e.keyCode == dojo.keys.ENTER){
		                room.join(dojo.byId('username').value);
		                return false;
		            }
		            return true;
			    });

		        element=dojo.byId('joinB');
		        element.onclick = function(){
		            room.join(dojo.byId('username').value);
		            return false;
			    }

		        element=dojo.byId('phrase');
		        element.setAttribute("autocomplete","OFF");
		        dojo.connect(element, "onkeyup", function(e){   
		            if(e.keyCode == dojo.keys.ENTER){
		                room.chat(dojo.byId('phrase').value);
		                dojo.byId('phrase').value='';
		                return false;
		            }
		            return true;
			    });

		        element=dojo.byId('sendB');
		        element.onclick = function(){
		        	room.chat(dojo.byId('phrase').value);
		        	dojo.byId('phrase').value='';
				}

		        element=dojo.byId('leaveB');
		        element.onclick = function(){
		        	room.leave();
				}
		    } 
		};

		dojo.addOnLoad(function(){
		   dojox.cometd.init("http://localhost:3000/cometd");
		   dojo.connect(dojo.byId("counter_button"), "onclick", counter, "start_stop");
		   dojo.connect(dojo.byId("rpc_button"), "onclick", rpc, "invoke");
		});
		dojo.addOnLoad(room, "_init");
		
		dojo.addOnUnload(room,"leave");	
		dojo.addOnUnload(function(){
		   dojox.cometd.disconnect();
		});	
					
	</script>
	
	<style>
		
	div 
	{ 
	  border: 0px solid black; 
	}

	div.container
	{
	  background-color: #e0e0e0;
	  border: 1px solid black; 
	  width: 45em;
	}

	div.output
	{
	  height: 20ex;
	  overflow: auto; 
	  background-color: #f0f0f0;
	  padding: 4px;
	  border: 0px solid black; 
	}

	div.input
	{
	  clear: both;
	  padding: 4px;
	  border: 0px solid black; 
	  border-top: 1px solid black; 
	}

	input#rpc_text
	{
	  width:28em;
	  background-color: #e0f0f0;
	}

	input#rpc_delay
	{
	  width:7em;
	  background-color: #e0f0f0;
	}
	
	input#phrase
	{
	  width:28em;
	  background-color: #e0f0f0;
	}

	input#username
	{
	  width:14em;
	  background-color: #e0f0f0;
	}

	div.hidden
	{
	  display: none;
	}

	span.from
	{
	  font-weight: bold;
	}

	span.alert
	{
	  font-style: italic;
	}

	h2
	{
	  color: #333333;
	}
		
	h3
	{
	  color: #444444;
	  margin-bottom: 5px;
	}
	</style>
		
</head>
<body>
	<h2>ErlyComet Demos</h2>

	<h3>1. Epoch-time-mod-1000 counter</h3>
	<div class="container">
   		<div id="counter_output" class="output" style="height:3ex"></div>
   		<div class="input">
    		<div>
       			Server side implemented counter:&nbsp;
				<button id="counter_button">start</button>
     		</div>
    	</div>
   	</div>

	<h3>2. RPC - delayed echo</h3>
	<div class="container">
   		<div id="rpc_output" class="output" style="height:3ex"></div>
   		<div class="input">
    		<div>
    			Value:
				<input id="rpc_text" type="text">&nbsp;&nbsp;
				Delay (in sec):
				<input id="rpc_delay" type="text">&nbsp;
                <input id="rpc_button" class="button" type="submit" name="join" value="Invoke">
    		</div>
    	</div>
   	</div>		

	<h3>3. Simple Chat (code from: http://cometd.com/ SVN repository)</h3>	
 	<div class="container">
		<div id="chat" class="output" style="height:14ex"></div>
		<div class="input">
			<div id="join" >
   				Username:&nbsp;<input id="username" type="text"><input id="joinB" class="button" type="submit" name="join" value="Join"/>
  			</div>
   			<div id="joined" class="hidden">
   				Chat:&nbsp;<input id="phrase" type="text">
   				<input id="sendB" class="button" type="submit" name="join" value="Send">
   				<input id="leaveB" class="button" type="submit" name="join" value="Leave">
   			</div>
   		</div>
	</div>	

</body>


